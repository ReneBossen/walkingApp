# Plan 9.4: Navigation Structure

## Summary

Implement React Navigation with authentication flow, bottom tab navigation for main screens, stack navigation for nested flows, deep linking for invite codes and friend requests, and 18 placeholder screens. This creates the navigational backbone for the entire mobile app.

## Affected Feature Slices

- **Frontend/Navigation**: All navigation components
- **Frontend/Screens**: Screen structure organization

## Prerequisites

- Plan 9.1: Expo Project Initialization (project structure exists)
- Plan 9.3: Supabase Client Configuration (auth status available)

## Navigation Architecture

```
RootNavigator
├── AuthStack (if not authenticated)
│   ├── Login
│   ├── Register
│   └── ForgotPassword
│
└── MainStack (if authenticated)
    ├── TabNavigator (bottom tabs)
    │   ├── HomeStack
    │   │   ├── Home/Dashboard
    │   │   └── (modal screens)
    │   ├── StepsStack
    │   │   ├── StepsHistory
    │   │   └── (modal screens)
    │   ├── FriendsStack
    │   │   ├── FriendsList
    │   │   ├── FriendDiscovery
    │   │   └── UserProfile
    │   ├── GroupsStack
    │   │   ├── GroupsList
    │   │   ├── GroupDetail
    │   │   └── GroupManagement
    │   └── SettingsStack
    │       ├── Settings
    │       ├── Profile
    │       └── EditProfile
    │
    └── Modal Screens (outside tabs)
        ├── Onboarding
        ├── Notifications
        └── (other modals)
```

## Implementation Steps

### 1. Install Dependencies

```bash
cd WalkingApp.Mobile

# Core navigation
npx expo install @react-navigation/native
npx expo install react-native-screens react-native-safe-area-context

# Navigators
npm install @react-navigation/native-stack
npm install @react-navigation/bottom-tabs

# For deep linking
npx expo install expo-linking
```

### 2. Create Navigation Types

Create `src/navigation/types.ts`:

```typescript
import type { NativeStackScreenProps } from '@react-navigation/native-stack';
import type { BottomTabScreenProps } from '@react-navigation/bottom-tabs';
import type { CompositeScreenProps } from '@react-navigation/native';

// Root Navigator
export type RootStackParamList = {
  Auth: undefined;
  Main: undefined;
  Onboarding: undefined;
};

// Auth Stack
export type AuthStackParamList = {
  Login: undefined;
  Register: undefined;
  ForgotPassword: undefined;
};

// Main Stack (contains tabs + modals)
export type MainStackParamList = {
  Tabs: undefined;
  Notifications: undefined;
};

// Tab Navigator
export type TabParamList = {
  HomeTab: undefined;
  StepsTab: undefined;
  FriendsTab: undefined;
  GroupsTab: undefined;
  SettingsTab: undefined;
};

// Home Stack
export type HomeStackParamList = {
  Home: undefined;
};

// Steps Stack
export type StepsStackParamList = {
  StepsHistory: undefined;
};

// Friends Stack
export type FriendsStackParamList = {
  FriendsList: undefined;
  FriendDiscovery: undefined;
  UserProfile: { userId: string };
};

// Groups Stack
export type GroupsStackParamList = {
  GroupsList: undefined;
  GroupDetail: { groupId: string };
  GroupManagement: { groupId: string };
  CreateGroup: undefined;
  JoinGroup: undefined;
};

// Settings Stack
export type SettingsStackParamList = {
  Settings: undefined;
  Profile: undefined;
  EditProfile: undefined;
};

// Screen props types
export type RootStackScreenProps<T extends keyof RootStackParamList> =
  NativeStackScreenProps<RootStackParamList, T>;

export type AuthStackScreenProps<T extends keyof AuthStackParamList> =
  NativeStackScreenProps<AuthStackParamList, T>;

export type HomeStackScreenProps<T extends keyof HomeStackParamList> =
  CompositeScreenProps<
    NativeStackScreenProps<HomeStackParamList, T>,
    RootStackScreenProps<keyof RootStackParamList>
  >;

// Declare global navigation type
declare global {
  namespace ReactNavigation {
    interface RootParamList extends RootStackParamList {}
  }
}
```

### 3. Create Root Navigator

Create `src/navigation/RootNavigator.tsx`:

```typescript
import React, { useEffect, useState } from 'react';
import { NavigationContainer } from '@react-navigation/native';
import { createNativeStackNavigator } from '@react-navigation/native-stack';
import * as Linking from 'expo-linking';

import AuthNavigator from './AuthNavigator';
import MainNavigator from './MainNavigator';
import OnboardingScreen from '@screens/onboarding/OnboardingScreen';
import { supabase } from '@services/supabase';
import { RootStackParamList } from './types';

const Stack = createNativeStackNavigator<RootStackParamList>();

const linking = {
  prefixes: ['walkingapp://', 'https://walkingapp.com'],
  config: {
    screens: {
      Auth: {
        screens: {
          Login: 'login',
          Register: 'register',
          ForgotPassword: 'forgot-password',
        },
      },
      Main: {
        screens: {
          Tabs: {
            screens: {
              FriendsTab: {
                screens: {
                  UserProfile: 'user/:userId',
                },
              },
              GroupsTab: {
                screens: {
                  GroupDetail: 'group/:groupId',
                  JoinGroup: 'join/:inviteCode',
                },
              },
            },
          },
        },
      },
    },
  },
};

export default function RootNavigator() {
  const [isAuthenticated, setIsAuthenticated] = useState<boolean | null>(null);
  const [needsOnboarding, setNeedsOnboarding] = useState(false);

  useEffect(() => {
    // Check initial session
    supabase.auth.getSession().then(({ data: { session } }) => {
      setIsAuthenticated(!!session);
      
      // Check if user needs onboarding (check user metadata)
      if (session?.user?.user_metadata?.onboarding_completed === false) {
        setNeedsOnboarding(true);
      }
    });

    // Listen for auth changes
    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange((event, session) => {
      setIsAuthenticated(!!session);
      
      if (event === 'SIGNED_IN' && session?.user) {
        // Check onboarding status
        if (session.user.user_metadata?.onboarding_completed === false) {
          setNeedsOnboarding(true);
        }
      }
      
      if (event === 'SIGNED_OUT') {
        setNeedsOnboarding(false);
      }
    });

    return () => subscription.unsubscribe();
  }, []);

  // Show loading or splash screen while checking auth
  if (isAuthenticated === null) {
    return null; // Or <SplashScreen />
  }

  return (
    <NavigationContainer linking={linking}>
      <Stack.Navigator screenOptions={{ headerShown: false }}>
        {!isAuthenticated ? (
          <Stack.Screen name="Auth" component={AuthNavigator} />
        ) : needsOnboarding ? (
          <Stack.Screen name="Onboarding" component={OnboardingScreen} />
        ) : (
          <Stack.Screen name="Main" component={MainNavigator} />
        )}
      </Stack.Navigator>
    </NavigationContainer>
  );
}
```

### 4. Create Auth Navigator

Create `src/navigation/AuthNavigator.tsx`:

```typescript
import React from 'react';
import { createNativeStackNavigator } from '@react-navigation/native-stack';
import { AuthStackParamList } from './types';

// Import screens (will be created in Plan 10)
import LoginScreen from '@screens/auth/LoginScreen';
import RegisterScreen from '@screens/auth/RegisterScreen';
import ForgotPasswordScreen from '@screens/auth/ForgotPasswordScreen';

const Stack = createNativeStackNavigator<AuthStackParamList>();

export default function AuthNavigator() {
  return (
    <Stack.Navigator
      screenOptions={{
        headerShown: false,
        animation: 'slide_from_right',
      }}
    >
      <Stack.Screen name="Login" component={LoginScreen} />
      <Stack.Screen name="Register" component={RegisterScreen} />
      <Stack.Screen name="ForgotPassword" component={ForgotPasswordScreen} />
    </Stack.Navigator>
  );
}
```

### 5. Create Main Navigator

Create `src/navigation/MainNavigator.tsx`:

```typescript
import React from 'react';
import { createNativeStackNavigator } from '@react-navigation/native-stack';
import { MainStackParamList } from './types';

import TabNavigator from './TabNavigator';
import NotificationsScreen from '@screens/notifications/NotificationsScreen';

const Stack = createNativeStackNavigator<MainStackParamList>();

export default function MainNavigator() {
  return (
    <Stack.Navigator>
      <Stack.Screen
        name="Tabs"
        component={TabNavigator}
        options={{ headerShown: false }}
      />
      <Stack.Group screenOptions={{ presentation: 'modal' }}>
        <Stack.Screen name="Notifications" component={NotificationsScreen} />
      </Stack.Group>
    </Stack.Navigator>
  );
}
```

### 6. Create Tab Navigator

Create `src/navigation/TabNavigator.tsx`:

```typescript
import React from 'react';
import { createBottomTabNavigator } from '@react-navigation/bottom-tabs';
import { MaterialCommunityIcons } from '@expo/vector-icons';
import { TabParamList } from './types';

import HomeStackNavigator from './stacks/HomeStackNavigator';
import StepsStackNavigator from './stacks/StepsStackNavigator';
import FriendsStackNavigator from './stacks/FriendsStackNavigator';
import GroupsStackNavigator from './stacks/GroupsStackNavigator';
import SettingsStackNavigator from './stacks/SettingsStackNavigator';

const Tab = createBottomTabNavigator<TabParamList>();

export default function TabNavigator() {
  return (
    <Tab.Navigator
      screenOptions={{
        headerShown: false,
        tabBarActiveTintColor: '#4CAF50',
        tabBarInactiveTintColor: '#757575',
      }}
    >
      <Tab.Screen
        name="HomeTab"
        component={HomeStackNavigator}
        options={{
          title: 'Home',
          tabBarIcon: ({ color, size }) => (
            <MaterialCommunityIcons name="home" size={size} color={color} />
          ),
        }}
      />
      <Tab.Screen
        name="StepsTab"
        component={StepsStackNavigator}
        options={{
          title: 'Steps',
          tabBarIcon: ({ color, size }) => (
            <MaterialCommunityIcons name="walk" size={size} color={color} />
          ),
        }}
      />
      <Tab.Screen
        name="FriendsTab"
        component={FriendsStackNavigator}
        options={{
          title: 'Friends',
          tabBarIcon: ({ color, size }) => (
            <MaterialCommunityIcons name="account-group" size={size} color={color} />
          ),
        }}
      />
      <Tab.Screen
        name="GroupsTab"
        component={GroupsStackNavigator}
        options={{
          title: 'Groups',
          tabBarIcon: ({ color, size }) => (
            <MaterialCommunityIcons name="trophy" size={size} color={color} />
          ),
        }}
      />
      <Tab.Screen
        name="SettingsTab"
        component={SettingsStackNavigator}
        options={{
          title: 'Settings',
          tabBarIcon: ({ color, size }) => (
            <MaterialCommunityIcons name="cog" size={size} color={color} />
          ),
        }}
      />
    </Tab.Navigator>
  );
}
```

### 7. Create Stack Navigators for Each Tab

Create `src/navigation/stacks/HomeStackNavigator.tsx`:

```typescript
import React from 'react';
import { createNativeStackNavigator } from '@react-navigation/native-stack';
import { HomeStackParamList } from '../types';

import HomeScreen from '@screens/home/HomeScreen';

const Stack = createNativeStackNavigator<HomeStackParamList>();

export default function HomeStackNavigator() {
  return (
    <Stack.Navigator>
      <Stack.Screen
        name="Home"
        component={HomeScreen}
        options={{ title: 'Walking App' }}
      />
    </Stack.Navigator>
  );
}
```

Create similar navigators for:
- `StepsStackNavigator.tsx`
- `FriendsStackNavigator.tsx`
- `GroupsStackNavigator.tsx`
- `SettingsStackNavigator.tsx`

### 8. Create Placeholder Screens

Create 18 placeholder screens in their respective folders:

**Auth Screens (3)**:
- `src/screens/auth/LoginScreen.tsx`
- `src/screens/auth/RegisterScreen.tsx`
- `src/screens/auth/ForgotPasswordScreen.tsx`

**Home Screens (1)**:
- `src/screens/home/HomeScreen.tsx`

**Steps Screens (1)**:
- `src/screens/steps/StepsHistoryScreen.tsx`

**Friends Screens (3)**:
- `src/screens/friends/FriendsListScreen.tsx`
- `src/screens/friends/FriendDiscoveryScreen.tsx`
- `src/screens/friends/UserProfileScreen.tsx`

**Groups Screens (5)**:
- `src/screens/groups/GroupsListScreen.tsx`
- `src/screens/groups/GroupDetailScreen.tsx`
- `src/screens/groups/GroupManagementScreen.tsx`
- `src/screens/groups/CreateGroupScreen.tsx`
- `src/screens/groups/JoinGroupScreen.tsx`

**Settings Screens (3)**:
- `src/screens/settings/SettingsScreen.tsx`
- `src/screens/settings/ProfileScreen.tsx`
- `src/screens/settings/EditProfileScreen.tsx`

**Other Screens (2)**:
- `src/screens/onboarding/OnboardingScreen.tsx`
- `src/screens/notifications/NotificationsScreen.tsx`

Example placeholder:

```typescript
import React from 'react';
import { View, Text, StyleSheet } from 'react-native';

export default function HomeScreen() {
  return (
    <View style={styles.container}>
      <Text>Home Screen</Text>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
});
```

### 9. Configure Deep Linking

Update `app.json`:

```json
{
  "expo": {
    "scheme": "walkingapp",
    "android": {
      "intentFilters": [
        {
          "action": "VIEW",
          "autoVerify": true,
          "data": [
            {
              "scheme": "https",
              "host": "walkingapp.com",
              "pathPrefix": "/"
            },
            {
              "scheme": "walkingapp"
            }
          ],
          "category": ["BROWSABLE", "DEFAULT"]
        }
      ]
    }
  }
}
```

## Database Changes

None. Navigation is frontend-only.

## Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| @react-navigation/native | ^6.x | Core navigation library |
| @react-navigation/native-stack | ^6.x | Stack navigator |
| @react-navigation/bottom-tabs | ^6.x | Bottom tab navigator |
| react-native-screens | Latest | Native screen optimization |
| react-native-safe-area-context | Latest | Safe area handling |
| expo-linking | Latest | Deep linking support |

## Tests

**Navigation Tests**:
```typescript
describe('Navigation', () => {
  it('shows auth stack when not authenticated', () => {
    // Test navigation to login screen
  });

  it('shows main stack when authenticated', () => {
    // Test navigation to home screen
  });

  it('shows onboarding after signup', () => {
    // Test onboarding flow
  });

  it('handles deep links correctly', () => {
    // Test deep link navigation
  });
});
```

## Acceptance Criteria

- [ ] React Navigation installed and configured
- [ ] Root navigator switches between Auth/Main based on auth state
- [ ] Auth stack contains Login, Register, ForgotPassword
- [ ] Main stack contains bottom tabs
- [ ] Bottom tabs contain 5 tabs (Home, Steps, Friends, Groups, Settings)
- [ ] Each tab has its own stack navigator
- [ ] Placeholder screens created for all main screens
- [ ] Deep linking configured for invite codes
- [ ] Navigation types properly typed with TypeScript
- [ ] Auth state listener updates navigation
- [ ] Onboarding shown for new users
- [ ] Modal screens (Notifications) work correctly
- [ ] Tab bar icons display correctly
- [ ] Navigation transitions smooth

## Dependencies on Other Plans

**Requires**:
- Plan 9.1: Expo Project Initialization
- Plan 9.3: Supabase Client Configuration (for auth state)

**Blocks**:
- Plan 10-19: All UI screens (need navigation structure)
- Plan 9.6: Theme & Styling (needs navigation container)

## Risks and Mitigations

| Risk | Mitigation |
|------|------------|
| Deep link conflicts | Test all deep link patterns |
| Navigation state issues | Use linking config properly |
| Type safety for navigation | Use provided TypeScript types |
| Tab bar overlap on Android | Use safe area insets |

## Notes

- Placeholder screens will be replaced in Plans 10-19
- Deep linking will be tested with actual invite codes in Plan 15
- Tab icons from MaterialCommunityIcons, can be customized later
- Navigation state persists automatically with React Navigation
- Auth listener ensures navigation stays in sync with auth state

